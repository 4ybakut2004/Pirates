var gl;											//главная GL херня

var posx_g;										//x игрока  
var posy_g;										//y игрока
var posx_m; 									//x монстрика
var posy_m;										//y монстрика
var bal;										//количество, собранных монеток!

var k = 38;										//количество буферов (по количеству кратинок)
var flag;										//флаг прыжка
var fl_p;										//флаг pause
var rab;										//номер исходной картинки
var y_m;										//положение по у монеток

var canvas;										//тут все ясно, хост
var currentlyPressedKeys = new Array();			//массив нажатых клавишь
						
var shaderProgram;								//главная шейдерная херня	
var resolutionLocation;							//это нам для шейдера, зачем только -___-				

var objVertexPositionBuffer = new Array();		//координатный буффер
var objVertexTextureCoordBuffer = new Array(); 	//текстурный буффер

var kol, kol_b, kol_br, kol_ya;					//пока костыли
var mouseDown = false;							//отслеживание мышки
var mas_mon = new Array();						//массив монеток
var mas_fl = new Array();						//массив флагов
var mas_fon = new Array();						//массив фонов
var mas_fon_fl = new Array();					//массив фонов флагов
var mas_br = new Array();						//массив бомбы
var mas_br_fl = new Array();					//массив бомбы флагов
var mas_br_y = new Array();						//массив у бомб
var mas_brev = new Array();						//массив бревен
var mas_yac = new Array();						//массив якорей
var texture = new Array();						//массив айдишников текстур

var s;											//скорость человечка
var s_m;										//скорость момнеток
var s_b;										//скорость бомб
var s_br;										//скорость бревен
var s_ya;										//скорость якорей

var mus = 0;									//флаг на проигрыш музыки
var fl_bl;										//для какого-то хитрого подсчета ага -____-	
var fl_over;								    //конец игры!	
var code;										//не перезаписыват!!	

var met;										//метры
var his;										//истории
var cl_st;										//закрыта ли история		

var mas_shu = new Array();						//координаты по у шупальцев
var s_x, s_y;									//координаты звезды
var fl_shit;									//защита от бомб
var go;											//пробег с аурой

//var mas_point = new Array(1, 2, 3, 4, 5, 6, 7); 
var mas_point = new Array(20, 50, 100, 300, 700, 1000, 1200); 
var mas_pr = new Array(							//массив правил
"Сперва выберите персонажа, за которого будете играть. Для начала нашего славного приключения нажмите клавишу d. Бежать от врага тебе поможет та же самая клавиша. А клавиши w и s помогут тебе уворачиваться от бомб и ловить монетки, столь ценные в нашем деле.",
"На пути тебе буду встречать якори и бревна, увиливай от них, иначе придется начать заново! Следи за черепками, что появляются в правом углу экрана, чем больше их, тем ближе ты к открытию новой части истории. Для каждого героя своя легенда! Собери все!<br/>  Открытые истории закрывают по Enter!",
"На дно моское иногда опускаются заветные капельки, не забывай их ловить, они помогут тебе проскальзывать невредимым даже тогда, когда ты поймаешь бомбу!",
"Если ты захочешь отдохнуть, то жми p или воспользуйся кнопкой паузы на панели.",
"Надоела музыка? Воспользуйся панельными кнопками. Там же имеются и регуляторы громкости. Не теряйся!",
"Хочешь узнать о нас? Ищи кнопку с мотором, там ты узнаешь не только о нашей команде, но и об обновлениях игры!",
"Пора начинать новую игру? Не беда, ищи кнопку на панели с закругленной стрелкой и продолжай наше великое путешествие!",
"Ну и напоследок! Если у тебя зависает или не обновляется игра, значит тебе пора:<br/>1. Почистить кэш;<br/>2. Перезагрузить браузер;<br/>3. Перезгрузить ваш ПК;<br/>4. Ну и на самый скверный случай, обновить браузер.<br/>5. Не забывайте о возможностях вашей видеокарты! <br/> <p align=\"center\">Удачи!</p>"
);

var mas_str = new Array(
// Лиззи
"- Когда-нибудь я увижу его снова. – Внутри все сжалось от этих слов, Элизабет опустила голову и вздохнула.<br/>" +
"- Капитан? – дверь немного приоткрывается, и в щель заглядывает голова — малоприятная, малознакомая.",

"— Что тебе? – Капитан Лиззи, хотя нет, для всех она капитан или кэп, кто смеет только назвать ее Лиззи или милашкой," +
" оказывается за бортом. Она давно уже не та, что раньше. Ее стихией стали моря, а не пышные платья и светские беседы.<br>" +
"— Там кончился ром. — Парнишка остолбенел, побледнел, и, кажется, совсем потерял дар речи. ",


"— Рома нет. — Повторил он и окончательно замолчал. Элизабет было возрадовалась, что это мерзкое пойло покинуло ее корабль," +
" но статус капитана не позволял, все пираты заливают морские раны ромом.",

"— Разве у нас не было пятнадцать бочек?<br/>" +
"— Было.<br/>" +
"— Так, где же ром?<br/>" +
"— Гиббс…<br/>" +
"— Что с ним не так?",

"— Мы не оставили его в порту, капитан! Он снова залег в «грузовом» с ромом.<br/>" +
"— Когда-нибудь я встречу его снова, да? — тихо шепчет себе под нос Элизабет и усмехается." +
" — Не так же скоро, и, черт возьми, почему снова мой ром?!",

// Сяо
"Когда-то давно отец рассказывал ему, что все пираты хоть и кажутся отшельниками, бунтарями, которые готовы чтить только свой и ничей" +
" больше кодекс, знаю, что такое честь. Конечно, эта не так, что у благородных дам и их рыцарей. Пиратская честь – совсем другое.",

"— Я стал капитаном задолго до твоего рождения, сынок. Сколько морей успел пробороздить, скольких людей повидать, а скольких поубивать." +
" — Голос отца немного дрогнул, но он продолжал свой рассказ.",

"— Мать твоя я совсем не помню, мы виделись с ней единожды, хотя она утверждала, что это было куда больше раз. Не верь, сынок, женщинам," +
" они лживее и коварнее пиратов. И хоть она была такой, знаешь, я всегда верил, что ты мой. У нас с тобой одна кровь течет в жилах, один огонь горит в глазах! ",

"— Отец кашлянул, сделал глоток рома из бутылки. Они впервые говорили так, до этого Сяо-Фень никогда доброго слова не говорил мальчонке.",

"— Капитан! Мы получили известие! — мужчина приоткрывает один глаз, и только сейчас понимает, что это всего лишь сон, и он давно не тот мальчишка, а отец.  О нем он думает иначе.",

// Коттон
"Коттон всегда мечтал стать пиратом. Капитаном корабля. У них всегда были люди в подчинении, море рома," +
" женщин и на поводке рядом какая-то зверушка. Животных Коттон любил, особенно птиц, говорил он плохо," +
" собеседников  кроме попугаев у него никогда и не было.",

"Коттон лишился своего языка пару лет назад и теперь пытается научиться языку жестов.Это выходит неуклюже, смешно и Коттон расстраивается все чаще.",

"Через год он учится писать, но все его окружение необучено письму и это лишь пустая трата времени. Он пробует новый способ," +
" расстраивается и пробует вновь, пока его не забрасывает на остров.",

"Так он познакомился с попугаем. Он гладил его, а тот млел, бегал по его руке, отбирал ром изо рта, когда Коттон решал выпить." +
"  А через время заговорил. Где он научился и как, оставалось загадкой.",

"Главное, его мысли зачастую совпадали с тем, что он говорил.  Так Коттон приобрел себе друга, собеседника," +
" что понимал его без слов, но и того, кто сможет выражать его мысли.",

// Джек
"Когда Джек был маленький, у него было домашнее животное. Крыса — Джек поймал ее в трюме. Когда ему становилось" +
" скучно, он кормил крысу сухарями и солониной и учил прыгать через веревочку.",

"Прыгала крыса неохотно, но Джек все равно ее любил, потому что она грызла манжеты рубашек Гектора Барбоссы и очень" +
" громко визжала, если посильнее сжать ее в кулаке. Папаша Тиг крысу не любил и завел на корабле кошку. Кошку назвали Лиззи.",

"С тех пор Джеку не очень-то нравится это имя. От Лиз одни неприятности. В этом он удостоверился, когда он встретил Элизабет Суон. Та еще штучка.",

"— Лиззи, — говорил Джек, оставаясь с Элизабет наедине. Он представлял перед собой кошку, которая давила его любимую крысу. Слова летели из его уст быстрее, чем он успевал подумать.",

"— Портовым шлюхам не место на корабле, — смеялся Джек. Эта Лиззи показала ему, где место таким как он. Хотя он до сих пор сомневается" +
" в правильности его наказания. В пасти у кракена не самое теплое место.",

// Билл
"Билл очень быстро шел ко дну. Легкие постепенно заполняла соленая морская вода." + 
" Тело ломило от холода и от мысли, что он является чем-то незначительным в этом мире, как и все вокруг." + 
" Именно от этой мысли Биллу было легче. Легче, раз эти твари будут помнить его всю свою бессмертную жизнь.",

"Глаза Билла еще видели мерцающий свет, пробивающийся сквозь толщу воды. Силы таяли, Билл все глубже уходил под воду." +
" Тёрнер наконец-то почувствовал грубый толчок о дно и потерял сознание навсегда.",

"Последнее, что он запомнил – это не тёплый спокойный свет солнца, а густая тьма, давящая на него со всех сторон," +
" и морской холод, проникающий по всему телу, словно змея.",

"И, наконец-то, пришло забвение. «Согласишься ли ты на моё предложение?» - вдруг прозвучало в его голове, когда уже давно никто не обращался к нему.",

"«Да!» - коротко и незамедлительно ответил он и вновь открыл глаза, по-прежнему ощущая тот же давящий холод. Он дал клятву, теперь он будет жить вечно.",


// Барбосса
"— Меняю корабль на яблоко. — Их переговоры уже длятся около часа. Джек не хочет уступать корабль, а Барбосса – яблоки.<br/>" +
"— Еще недавно ты предлагал ящик яблок. — Джек пожимает плечами, достает из кармана яблоко и со всей жадностью впивается в него зубами, сок струиться по его подбородку и рукам.",

"— Это устаревшее предложение. Ты упустил свой шанс, так что теперь яблоко на корабль.<br/>" +
"— Значит, ты хочешь, чтобы я отдал тебе корабль взамен на яблоко, одно яблоко?<br/>" +
"— Поправочка, я хочу получить за одно яблоко черную Жемчужину, она отойдет ко мне со всей командой.",

"— Зная тебя, ты попытаешься мне отдать это обслюнявленное тобой яблоко, а другого я не вижу.<br/>" +
"— О, Барбосса, у меня их много.<br/>" +
"— Докажи.<br/>" +
"— Нет, так не пойдет, ты можешь выяснить, где все яблоки, и тогда я не получу корабль.",

"— Где гарантии, что я получу яблоки?<br/>" +
"— Нет гарантий, но я не вру.<br/>" +
"— Джек воробей…<br/>" +
"— Капитан, — поправляет Джек.",

"— И не врет, это что-то новенькое.<br/>" +
"— Ну, так что? Корабль на яблоко? – Барбосса вздыхает, меняет положение на стуле," +
" предчувствуя, что их торг еще не скоро закончится.",

// Норрингтон
"Выпивая в очередной захудалой таверне, Норрингтон, изрядно уже перебрав, бомотал в остатки пойла:<br/>" + 
"— Вся жизнь пошла под хвост! Под хвост это воробья. Да, под воробьиный хвост! — Норрингтон сделал глоток обжигающей жидкости.",

"—Чего ты все бормочешь? — возмущается сидящий рядом мужик.<br/>" + 
"— Пираты – мелкие, ничтожные, не умеют ни сочувствовать, ни сожалеть." + 
" Нет у них ни цели в жизни, ни стремлений. Только женщины, море, да ром." + 
" Море женщин в роме. — Продолжал бормотать Норрингтон, изрядно напрягая разговаривающего с ним пьянчужку.",

"— Эй! — все резко заглохли и обернулись к двум привлекающим внимание. — Эта грязная свинья" + 
" говорит, что мы ничего не жаждем, кроме женщин! — Толпа заохала, заулюлюкала, а женщины разом" + 
" замялись на месте, поправляя свои прелести. ",

"– Рома! — снова довольное хрюканье из толпы, и глухие удары кружек.<br/>" + 
"– И моря! ",

"— Разве это не так? — говорит один из посетителей таверны.<br/>" + 
"— Вот станешь пиратом и узнаешь.",

"Ее пленил первый состав пиратских баронов. Заключил в тело женщины, заставил забыть" +
" о том, что море это она, что она это море. Пока четвертый состав не прибег к ее помощи.",

"Они наивно полагали, что ее можно просить, что она может быть благодарна." +
" Она могла лишь быть такой же коварной, как море, такой же строптивой, как буря.",

"Крушить все вокруг, потому что дремавшая сила вырвалась, сметая все на своем пути. Когда" +
" ее сердце успокоилось, она долго смотрела в море, вглядывалась в темные пучины, стараясь отыскать того, что захватила с собой.",

"Того, что смог ранить ее сердце, и дал ощутить себя живой.<br/>" +
"— Человечной, — сказал бы Деви, а она хмуро посмотрела на него и отвернулась.",

"Прошло уже несколько сотен лет, теперь она ни за что не признается, что любила, любит и будет любить его. Что сделает" +
" все, чтобы дать ему вновь бессмертие. Сделает все, чтобы вновь играть в игры по ее правилам, сводить с ума. ",

// Гиббс
"Гиббс не помнит, как очутился здесь, в длинном каменном коридоре. Наверно связался с шайкой паршивых" +
" пиратов, а они засадили его в эту ловушку. Он не видел никаких вариантов, кроме как идти вперед на" + 
" еле уловимый прохладный ветерок в надежде, что он заглянул сюда откуда-то снаружи.",

"Ветер нес в себе свободу, которую так хотелось сейчас почувствовать среди темных стен." + 
" Либо это было проявление хоть какого-то сочувствия, либо злая шутка, но ему оставили полную бутылку рома." +
" Каждый новый глоток прибавлял уверенности в своих силах. Пьяным он мог свернуть горы.",

"Вдруг вдалеке что-то сверкнуло. Пьяный пират подумал, что ему померещилось, но блеск повторился. И еще. И еще.",

"Сияние продолжало нарастать, пока Гиббс не добрел до огромной комнаты, наполненной золотом. Золотом и ромом." + 
" Здесь было столько рома и золота, что флоты всего мира не смогли бы перевезти их и за сотню лет.",

"Пират даже протрезвел от увиденного, что являлось довольно тяжелой задачей. И едва он поднес руку" +
" к монете, в лицо выплеснулась струя холодной воды. Он проснулся....<br/>" +
"— Нехорошо будить спящих людей, Джек. Это плохая примета.<br/>" +
"Это был всего лишь сон.",

// Пес 
"Легендарный пес! Так звали его когда-то, так должны были звать его когда-то.<br/>" +
"— Иди-иди сюда, вшивая дворняга! — Пес тоскливо смотрит своими умными глазищами на" +
" очередного заключенного, что решил подкупить его костью годовой давности, непонятно чьего происхождения" +
" – то ли человека, то ли какой-нибудь кобылы.",

"— Давай-давай, песик, иди сюда. — Мерзкое посвистывание, что режет по ушам. Сейчас заключенный напоминал ему щенка," +
" с большими просящими глазами и сердцем полным надежды.",


"Пес лениво делает шаг вперед, и человек за решеткой уже готов плясать от счастья, сочинять планы на вечер и" +
" практически ощущать привкус рома. При мысли о роме Пес дернул ушком, припоминая последнюю славную вылазку пиратов," +
" где ром лился рекой и мясо было в изобилии, как и женщин.",

"При мысли о женщине Пес снова дернул ушком, только уже с отвращением, ни одной нормальной женщины там не было, на его взгляд." +
" Все слишком большие, страшные и облезлые, с маленькими ушами и хвостами не в том месте.",

"— Иди, давай-давай, хороший Песик. — Он смотрит последний раз тоскливо на жалкого затворника, звенит ключами перед его носом," +
" и садится напротив следующей камеры, ожидая, когда же очередной олух решит его подкупить.",

// Уилл
"Когда ты являешься Капитаном корабля «Летучий Голландец» ты должен помнить обо всех своих обязанностях." +
"  Но когда твое сердце отдано одной единственной сложно помнить о них.",

"Ты каждый день напиваешься, пытаешься найти выход, а кроме смерти тебя ничего не ждет впереди. Ты падаешь вниз," +
" тонешь в соленой воде и не можешь выбраться на поверхность. Раз в десять лет. Твой приговор, который не подлежит оспариванию. ",

"Каждый раз ты вычеркиваешь дни на импровизированном календаре и стараешься думать о том, какой будет этот" +
" единственный день.  Проведете, его вы как десять лет назад, на берегу моря или где-то еще. ",

"Тебе столько нужно рассказать ей, поведать. Ты знаешь о сыне, но так ни разу его и не увидел. Ты пытаешься" +
" представить, на кого он похож, как изменилась она.  Каждый раз одно и тоже, и весь мир перестает вращаться, застывает.",

" Ты смотришь на календарь и ждешь слов, которые заставят его вращаться вновь.<br/>" +
"— Капитан, на горизонте земля.",

// Малрой
"— Мертог, а почему пираты пьют ром?<br/>" +
"— Не знаю, Малрой. Этому должна быть какая-то особенная причина?",

"— Ну конечно! Ты видел хоть одного пирата, который бы не пил ром?<br/>" +
"— Нет, не видел.<br/>" +
"— Вот! Ты не видел! Значит, этому есть какая-то причина. Обязательно есть. И почему именно ром? Почему не бренди? Все поголовно пьют именно ром.",

"— Может быть, им просто нравится его вкус?<br/>" +
"— Нет, ну какой вкус? Мне вот бренди нравится больше рома, гораздо больше. Не может быть дело просто во вкусе.<br/>" +
"— Ну, ты и не пират.",

"— Ну и что? Ну и что, что я не пират? Мы же тоже плаваем на кораблях. Наше отличие лишь в том, что они грабят, а мы их ловим.<br/>" +
"— Ну да. Наверное это так.",

"— Что за тип в шляпе? Гражданским вход воспрещен.<br/>" +
"— Вижу в первый раз, пошли, остановим его."
);		
var num_pr;										//номер открытого правила			
//---------------------------клавиши, мышки-----------------------------------------------
function handleKeyDown(event) 
{
	currentlyPressedKeys[event.keyCode] = true;
}
	 
function handleKeyUp(event) 
{
    currentlyPressedKeys[event.keyCode] = false;
}

function move_obj(num, sp, mas_m)
{
	for(var v = 0; v < num; v++) mas_m[v] -= sp;
}
function handleKeys() 
{
	if (currentlyPressedKeys[80] && flag) 
	{
		Pause();
		currentlyPressedKeys[80] = false;
	}
	if(document.getElementById('over').style.display!='block'&&flag&&fl_p&&!cl_st)
	{
		if (currentlyPressedKeys[68]) 
		{
			posx_m -= 1;
			move_obj(kol, s_m, mas_mon);
			move_obj(11, s, mas_fon);
			move_obj(kol_b, s_b, mas_br);
			move_obj(kol_br, s_br, mas_brev);
			move_obj(kol_ya, s_ya, mas_yac);
			if(fl_shit) go += s;
			s_x--;
			met += s;
			for(var f = 0; f<8; f++)
			{
				mas_shu[f] = Math.floor((Math.random()*10)-5) + posy_m;
			}	
		}
		if (currentlyPressedKeys[87]) 
		{
			if(posy_g>0) posy_g -= 5;
		}
		if (currentlyPressedKeys[83]) 
		{
			if(posy_g<370) posy_g += 5;
		}
    }
    if (currentlyPressedKeys[68]&&!flag&&rab) 
	{
		flag = 1;
	}
	if(currentlyPressedKeys[13])
	{
		Close();
	}
}

//---------------------------инициализация всего-----------------------------------------
function init_GL()
{
	canvas=document.getElementById("canvas");
	gl=getWebGLContext(canvas);
	if(!gl)
	{
		alert('Ваши драйвера утстарели или ваше видео карта не подерживает WebGL!');
		return;
	}
	
	gl.enable ( gl.BLEND ) ;
	gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
	
	//-------------------------пошли монетки инит-----------------------------------------
	y_m = Math.floor((Math.random()*400)+10);
	kol = Math.floor((Math.random()*10)+1);
	mas_mon[0] = Math.floor((Math.random()*700)+500);
	mas_fl[0] = 1;
	for(var i = 1; i < kol; i++) 
	{
		mas_mon[i] = mas_mon[i-1] + 50;
		mas_fl[i] = 1;
	}
	
	//-----------------------фоны инит----------------------------------------------------
	for(var i = 0; i < 11; i++) 
	{
		mas_fon[i] = 700*i;
		mas_fon_fl[i] = 0;
	}
	mas_fon_fl[0] = 1;
	mas_fon_fl[1] = 1;
	
	//----------------------бомбы инит----------------------------------------------------
	kol_b = Math.floor((Math.random()*10)+1);
	mas_br[0] = Math.floor((Math.random()*700)+500);
	mas_br_y[0] = Math.floor((Math.random()*400)+10);
	mas_br_fl[0] = 1;
	for(var i = 1; i < kol_b; i++)
	{
		mas_br[i] = mas_br[i-1] + Math.floor((Math.random()*200)+50);
		mas_br_y[i] = Math.floor((Math.random()*400)+10);
		mas_br_fl[i] = 1;
	}
	
	//---------------------щупальцы кальмарчика-------------------------------------------
	for(var f = 0; f<8; f++)
	{
		mas_shu[f] = Math.floor((Math.random()*10)-5) + posy_m;
	}
	
	//---------------------бревна инит----------------------------------------------------
	kol_br = Math.floor((Math.random()*2)+1);
	mas_brev[0] = Math.floor((Math.random()*700)+700);
	for(var i = 1; i < kol_br; i++)
	{
		mas_brev[i] = mas_brev[i-1] + Math.floor((Math.random()*300)+100);
	}
	
	//---------------------якоря инит----------------------------------------------------
	kol_ya = Math.floor((Math.random()*2)+1);
	mas_yac[0] = Math.floor((Math.random()*700)+600);
	for(var i = 1; i < kol_ya; i++)
	{
		mas_yac[i] = mas_yac[i-1] + Math.floor((Math.random()*300)+100);;
	}
}

function initShader()
{
	vertexShader=createShaderFromScriptElement(gl,"2d-vertex-shader");
	fragmentShader=createShaderFromScriptElement(gl,"2d-fragment-shader");
	
	shaderProgram = gl.createProgram();
	
	gl.attachShader(shaderProgram, vertexShader);
    gl.attachShader(shaderProgram, fragmentShader);
	
	gl.linkProgram(shaderProgram);
	if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
        alert('Can`t initialise shaders');
    }
	
	gl.useProgram(shaderProgram);
	
	shaderProgram.vertexPositionAttribute=gl.getAttribLocation(shaderProgram,"a_position");


	gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);
	
	shaderProgram.textureCoordAttribute=gl.getAttribLocation(shaderProgram,"a_texCoord");
	gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);
	
	shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, 'uSampler');
	
	resolutionLocation=gl.getUniformLocation(shaderProgram,"u_resolution");
	gl.uniform2f(resolutionLocation,canvas.width,canvas.height);
	
}

function initBuff()
{
	for(var i=0; i<k; i++)
	{
		objVertexPositionBuffer[i] = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, objVertexPositionBuffer[i]);
	}
	var i = 0;
	objVertexTextureCoordBuffer[i] = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, objVertexTextureCoordBuffer[i]);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0]),gl.STATIC_DRAW);
}

function initTex(texture)
{
	gl.bindTexture(gl.TEXTURE_2D,texture);
	gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
	gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.image);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
	gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
	gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
	gl.bindTexture(gl.TEXTURE_2D, null);
}

function createTex(image_name)
{
	var image = new Image();
	var texture = gl.createTexture();
	image.src = image_name;
	texture.image = image;
	image.onload = function()
	{
		initTex(texture);
	}
	return texture;
}
//---------------------------повторы--------------------------------------------------
function pov(px, py, w, h, nu)
{
	gl.bindTexture(gl.TEXTURE_2D, texture[nu]);
	gl.uniform1i(shaderProgram.samplerUniform, 0);
	gl.bindBuffer(gl.ARRAY_BUFFER, objVertexPositionBuffer[nu]);
					
	setRectangle(gl, px, py, w, h);
	gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute,2,gl.FLOAT,false,0,0);
					
	gl.bindBuffer(gl.ARRAY_BUFFER, objVertexTextureCoordBuffer[0]);
	gl.vertexAttribPointer(shaderProgram.textureCoordAttribute,2,gl.FLOAT,false,0,0);
					
	gl.drawArrays(gl.TRIANGLES,0,6);
	gl.bindTexture(gl.TEXTURE_2D, null);
}
//---------------------------отрисовка------------------------------------------------
var pos = 0;
var kon = 20;
var kl = 0;
function drawScene()
{	
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	
	if(!code)
	{
		if(go>1200){ fl_shit = 0; go = 0; }															//халява кончилась
		for(var j = 0; j<5; j++)
		{
			if(bal==mas_point[j]&&!fl_bl)
			{
				s_m ++;
				s ++;
				s_b ++;
				s_br ++;
				s_ya ++;
				fl_bl = 1;
				story();
				fl_p = 0;
				pos = j + 1;
			}
			if(bal==mas_point[j]+1) fl_bl = 0;
		}
		if(rab != 0)													//выбран ли герой!
		{
			if(posx_g-80<=posx_m&&posx_g>=posx_m||fl_over) gameOver();	//не пора ли заканчивать?)
			else
			{
				if(flag&&fl_p&&!cl_st)									//можно ли нам двигать?)
				{	
					move_obj(kol, s_m, mas_mon);
					move_obj(11, s, mas_fon);
					move_obj(kol_b, s_b, mas_br);
					move_obj(kol_br, s_br, mas_brev);
					move_obj(kol_ya, s_ya, mas_yac);
					if(fl_shit) go += s;
					s_y++;
					met += s;
					for(var f = 0; f<8; f++)
					{
						mas_shu[f] = posy_m + Math.floor((Math.random()*10)-5);
					}	
					if(posy_g<360) 
					{
						posy_g+=1; 
					}
					else
					{			
						if(posy_g<410) 
						{
							posy_g-=1;
						}
					}
					posx_m += 1;
				}
				var i;
				
				//---------------------фон----------------------------------------------------------
				if(mas_fon[10] <= 0)
				{
					for(var j = 0; j < 11; j++) 
					{
						mas_fon[j] = 700*j;
						mas_fon_fl[j] = 0;
					}
					mas_fon_fl[0] = 1;
					mas_fon_fl[1] = 1;
				}
				
				for(i=0; i<11; i++)
				{
					if(mas_fon_fl[i])
					{
						pov(mas_fon[i], 0, 700, 465, i);
					}
					if(mas_fon[i] < -700)
					{		
						mas_fon_fl[i] = 0;
						mas_fon_fl[(i + 2) % 11] = 1;
					}
				}
				//---------------------монетки------------------------------------------------------
				i = 25;
				if(mas_mon[kol - 1] < -100)
				{
					y_m = Math.floor((Math.random()*400)+10);
					kol = Math.floor((Math.random()*10)+2);
					mas_mon[0] = Math.floor(700 + Math.random()*1000);
					mas_fl[0] = 1;
					for(var v = 1; v < kol; v++)
					{
						mas_mon[v] = mas_mon[v-1] + 50;
						mas_fl[v] = 1;
					}
				}
					
				for(var q = 0; q<kol; q++)
				{
					if(mas_fl[q])
					{
						if(posy_g>=y_m-100 && posy_g<=y_m+50 && posx_g<=mas_mon[q] && posx_g>=-50+mas_mon[q])
						{
							bal ++;
							document.getElementById("bal").innerHTML = bal;
							mas_fl[q] = 0;	
						}
						pov(mas_mon[q], y_m, 50, 50, i);
					}
				}
				//---------------------монстр----------------------------------------------------------
				i = 26;
				var f = 0;
				for(var gk = i; gk < k - 1; gk++)
				{
					if(gk==26) pov(posx_m, posy_m, 200, 200, gk);
					else { pov(posx_m, mas_shu[f], 200, 200, gk); f++};
				}
				//---------------------бомбы---------------------------------------------------------
				i = 24;
				
				if(mas_br[kol_b - 1] < -100)
				{
					var asd = 0;
					for(var q = 0; q<kol_b; q++)
					{
						asd++;
					}
					if(asd == kol_b) if(posx_m-10>=0) posx_m -= 6;
					kol_b = Math.floor((Math.random()*10)+1);
					mas_br[0] = Math.floor((Math.random()*700)+500);
					mas_br_y[0] = Math.floor((Math.random()*400)+10);
					mas_br_fl[0] = 1;
					for(var i = 1; i < kol_b; i++)
					{
						mas_br[i] = mas_br[i-1] + Math.floor((Math.random()*200)+50);
						mas_br_y[i] = Math.floor((Math.random()*400)+10);
						mas_br_fl[i] = 1;
					}
				}
					
				for(var q = 0; q<kol_b; q++)
				{
					if(mas_br_fl[q])
					{
						if(posy_g>= mas_br_y[q]-80 && posy_g<= mas_br_y[q]+40 && posx_g<=mas_br[q] && posx_g>=-50+mas_br[q])
						{	
							if(!fl_shit)
							{
								mas_br_fl[q] = 0;
								posx_m += 5; 													//если аура не поймана
							}
						}
						pov( mas_br[q], mas_br_y[q], 50, 50, i);
					}
				}
				//---------------------герой--------------------------------------------------------
				pov(posx_g,posy_g, 100, 100, rab);
				
				//-----------------------------------бревна---------------------------------------------------
				i = k - 3;
				if(mas_brev[kol_br - 1] < -200)
				{
					kol_br = Math.floor((Math.random()*2)+1);
					mas_brev[0] = Math.floor((Math.random()*700)+700);
					for(var j = 1; j < kol_br; j++)
					{
						mas_brev[i] = mas_brev[i-1] + Math.floor((Math.random()*300)+100);
					}
				}
				for(var j = 0; j<kol_br; j++)
				{
					if(posy_g + 50 >= 370 && posy_g <= 370 + 100 && posx_g <= mas_brev[j] + 160 && posx_g + 30 >= mas_brev[j])
					{	
						fl_over = 1;
					}
					pov(mas_brev[j], 370, 200, 100, i);
				}
				
				//-----------------------------------якорь---------------------------------------------------
				i = k - 2;
				if(mas_yac[kol_ya - 1] < -100)
				{
					kol_ya = Math.floor((Math.random()*2)+1);
					mas_yac[0] = Math.floor((Math.random()*700)+700); 
					for(var j = 1; j < kol_ya; j++)
					{
						mas_yac[j] = mas_yac[j-1] + Math.floor((Math.random()*300)+100);
					}
				}
				for(var j = 0; j<kol_ya; j++)
				{
					if(posy_g + 50 >= 0 && posy_g<= 165 && posx_g + 50 >= mas_yac[j] && posx_g<=30+mas_yac[j])
					{	
						fl_over = 1;
					}
					pov(mas_yac[j], 0, 84, 200, i);
				}
				
				//------------------------------бонус!!!------------------------------------------------------		
				i = k - 1;
				var ah = Math.floor((Math.random()*100) + 1);
				if(s_y>400&&ah==2&&!fl_shit) 
				{
					s_x = Math.floor((Math.random()*700) + 300);
					s_y = -70;
				}
				if(posx_g + 50 >= s_x && posx_g <= s_x && posy_g + 50 >= s_y &&posy_g <= s_y) 
				{
					s_y = 500;
					fl_shit = 1;
				}
				pov(s_x, s_y, 50, 50, i);
				if(fl_shit)
				{
					pov(600, 60, 25, 25, i);
				}
					
				//------------------------------черепушечки----------------------------------------------------
				i = 23;
				if(pos==0 && bal==mas_point[pos]*kon/100)
				{ 
					kl++; 
					kon += 20;
				}
				else if(bal-mas_point[pos-1]==(mas_point[pos]-mas_point[pos-1])*kon/100){ kl++; kon += 20;}
				for(var l = 0; l < kl; l++)
				{
					pov(580 - 50*l, 5, 50, 50, i);
				}
			}
		}
	}
}


function main()
{
	Start();
	
	document.getElementById("p2").innerHTML = mas_pr[num_pr];	
	document.getElementById("p5").innerHTML = "Игра разработана командой <a href=\"http://fk-2o13.diary.ru/?tag=4902746\">fandom Pirates of the Caribbean 2013</a> для Фандомной битвы - 2013 на <a href=\"http://www.diary.ru/\">diary.ru</a> <br/>";
	//-----------------чтоб этот js!! с циклом не срабатывает, собака -___---------------
	
	var texturesPaths = 
	[
	// Фон
	"back_01.jpg", "back_02.jpg", "back_03.jpg", "back_04.jpg", "back_05.jpg",
	"back_06.jpg", "back_07.jpg", "back_08.jpg", "back_09.jpg", "back_10.jpg",
	"back_01.jpg",
	// Игроки
	"1.png", "2.png", "3.png", "4.png",  "5.png",  "6.png", 
	"7.png", "8.png", "9.png", "10.png", "11.png", "12.png",
	// Атрибутика
	"pol.png", "br.png", "den.png", 
	"kraken0.png", "kraken1.png", "kraken2.png", "kraken3.png",
	"kraken4.png", "kraken5.png", "kraken6.png", "kraken7.png", "kraken8.png",
	"brev.png", "yac.png", "sv.png"
	];

	for(var i = 0; i < 38; i++)
	{
		texture[i] = createTex(texturesPaths[i]);
	}
	
	document.getElementById('player').play();
	document.onkeydown = handleKeyDown;
	document.onkeyup = handleKeyUp;
   
	drawFrame(); 
}

function setRectangle(gl,x,y,width,height)
{
	var x1=x;
	var x2=x+width;
	var y1=y;
	var y2=y+height;
	gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([x1,y1,x2,y1,x1,y2,x1,y2,x2,y1,x2,y2]),gl.STATIC_DRAW);
}

function drawFrame() 
{
	requestAnimFrame(drawFrame);
	handleKeys();
	drawScene();
}

//----------------------------------------всякие доп. окна------------------------------
function ChangeImage(num, kul)
{
	var g = "";
	switch(kul)
	{
		case 1: g = "im1"; pic = "1.png"; break;
		case 2: g = "im2"; pic = "2.png"; break;
		case 3: g = "im3"; pic = "3.png"; break;
		case 4: g = "im4"; pic = "4.png"; break;
		case 5: g = "im5"; pic = "5.png"; break;
		case 6: g = "im6"; pic = "6.png"; break;
		case 7: g = "im7"; pic = "7.png"; break;
		case 8: g = "im8"; pic = "8.png"; break;
		case 9: g = "im9"; pic = "9.png"; break;
		case 10: g = "im10"; pic = "10.png"; break;
		case 11: g = "im11"; pic = "11.png"; break; 
		case 12: g = "im12"; pic = "12.png"; break;
	}
	if(num==2)
	{
		rab = 10 + kul;
		document.getElementById("wind").style.display = "none";
		document.getElementById("wind_bal").style.display = "block";
	}
	else
	{
		if(num) document.getElementById(g).width="110";
		else document.getElementById(g).width="100";
	}
}

function Close()
{
	if(document.getElementById('wind_story').style.display=='block')
	{
		document.getElementById('wind_story').style.display='none';
		fl_p = 1;
		kon = 20;
		kl = 0;
		cl_st = 0;
	}
}
function Close_about()
{
	document.getElementById('wind_about').style.display='none';
	return false;
}

function Close_over()
{
	document.getElementById('over_over').style.display='none';
	document.getElementById('over').style.display='block'; 
		
	document.getElementById('code_vs').style.display='block'; 
	
	met = (met - met%100)/100;
	document.getElementById('p3').innerHTML = "Ваш результат!<br/><br/>Количество монет......" + bal + "<br/>Пройдено метров......." + met + "<br/>Открыто историй......." + his;
	
	var s = "<textarea autofocus=\"autofocus\" id=\"inptext\" style=\"width:100%; height:100px; \" ><div style = \"width: 200px; height: 150px; color: #000; front-size: 10px; border-radius: 4px; background-color:#716a21; box-shadow: 2px 2px 6px #333, inset 0px 0px 10px #a89130; border: 1px solid #a18f52; filter: alpha(opacity=98); -moz-opacity: 0.98; -khtml-opacity: 0.98; opacity: 0.98;\" align=\"center\" ><img src=\"http://i.pixs.ru/storage/5/6/9/boardpng_6311240_8715569.png\" style = \"margin-top: 5px; \"><p style = \"margin-top: -23px; font-size:16px;\">Ваш результат!</p><p>";
 s += "<table cellpadding = 2> <tr><td>Количество монет</td><td width='20px' align=\"right\">" + bal + "</td></tr>";
 s += "<td>Пройдено метров</td><td width='20px' align=\"right\"> " + met + "</td></tr><tr>";
 s += "<td>Открыто историй</td><td width='20px' align=\"right\">" + his + "<td></tr></table>";
 s += "<p><p><p><a href=\"http://potc-game.herokuapp.com/\">Играть снова?</a>";
 s += "</div></textarea>";
	document.getElementById("p6").innerHTML=s;
	return false;
}

function over()
{
	document.getElementById('over_over').style.display='block'; 
	return false;
}

function card()
{
	document.getElementById('wind').style.display='block'; 
	return false;
}

function story()
{
	var sr = "<b>Bоодушевляющая история!</b><br/>";
	if(his<5)
	{
		sr += mas_str[(rab-11)*5+his];
	}
	else
	{
		sr += "Ты открыл все истории! <br/>Пока мы еще думаем,<br/>как же вознаградить тебя за этот подвиг, так что<br/>приходи позже и получи свою награду!!!";
	}
	document.getElementById("p4").innerHTML = sr;
	document.getElementById('wind_story').style.display='block';
	cl_st = 1;
	his++;
	return false;
}
//----------------------обнуление все, начинаем все заново!-----------------------------
function Start()
{
	posx_g = 200; 
	posy_g = 350;
	posx_m = 0; 
	posy_m = 260;
	bal = 0;
	rab = 0;
	flag = 0;
	fl_p = 1;
	s = 1;										
	s_m = 2;									
	s_b = 3;
	s_br = 2;
	s_ya = 2;
	fl_bl = 0;
	kon = 20;
	pos = 0;
	kl = 0;
	code = 0;
	fl_over = 0;
	met = 0;
	his = 0;
	num_pr = 0;
	cl_st = 0;
	
	fl_shit = 0;
	go = 0;
	
	s_x = Math.floor((Math.random()*700) + 200);
	s_y = -70;
	
	init_GL();
	initShader();	
	initBuff();
	
	card();
	
	document.getElementById("p2").innerHTML = mas_pr[num_pr];
	
	document.getElementById("wind_bal").style.display = "none";
	document.getElementById("bal").innerHTML = "0";
	
	document.getElementById('over').style.display='none';
	document.getElementById('code_vs').style.display='none';

	document.getElementById('wind_story').style.display='none';
	document.getElementById('wind_about').style.display='none';
	document.getElementById('over_over').style.display='none';
}

//------------------------------------перервыв на твикс---------------------------------
function Pause()
{
	if(flag) if(fl_p) fl_p = 0; else fl_p = 1;
}

//-------------------------------------конец игры---------------------------------------
function gameOver()
{
	if(!code)
	{
		document.getElementById("wind_bal").style.display = "none";
		code = 1;
		over();
	}
	return false;
}

//------------------------------------об игре и создателях------------------------------
function About()
{
	document.getElementById('wind_about').style.display='block';
	return false;
}

//-------------------------------------промотка правил----------------------------------
function List()
{
	if(num_pr == mas_pr.length - 1)  num_pr = 0;
	else num_pr++; 
	document.getElementById("p2").innerHTML = mas_pr[num_pr];
	return false;
}
